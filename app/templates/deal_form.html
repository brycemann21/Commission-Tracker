{% extends "base.html" %}
{% block content %}
<h1 class="text-xl font-bold mb-1">{{ "Edit Deal" if deal else "New Deal" }}</h1>
<div class="text-sm text-slate-500 mb-4">
  Matches your Excel payplan: Unit commission + add-ons + trade hold commission.
</div>

<form class="bg-white rounded border border-slate-200 p-4" method="post" action="/deals/save">
  {% if deal %}<input type="hidden" name="deal_id" value="{{ deal.id }}">{% endif %}

  <div class="grid md:grid-cols-3 gap-4">
    <div>
      <label class="text-xs text-slate-500">Sold Date</label>
      <input type="date" class="w-full border rounded px-3 py-2" name="sold_date" value="{{ deal.sold_date if deal else today().isoformat() }}">
    </div>
    <div>
      <label class="text-xs text-slate-500">Spot?</label>
      <div class="flex items-center gap-2 mt-2">
        <input type="checkbox" class="h-4 w-4" name="spot_sold" value="1" {% if deal and deal.spot_sold %}checked{% endif %}>
        <span class="text-sm text-slate-700">Yes (sets Delivered Date = today)</span>
      </div>
    </div>
    <div>
      <label class="text-xs text-slate-500">Status</label>
      <select class="w-full border rounded px-3 py-2" name="status">
        {% for s in ["Pending","Scheduled","Delivered","Dead"] %}
          <option value="{{ s }}" {% if deal and deal.status==s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
  <label class="text-xs text-slate-500">Tag</label>
  <select class="w-full border rounded px-3 py-2" name="tag">
    {% set current_tag = (deal.tag if deal and deal.tag is not none else "") %}
    <option value="" {% if current_tag == "" %}selected{% endif %}>—</option>
    {% for t in ["Shop","Title"] %}
      <option value="{{ t }}" {% if current_tag == t %}selected{% endif %}>{{ t }}</option>
    {% endfor %}
  </select>
</div>

    <div class="md:col-span-2">
      <label class="text-xs text-slate-500">Customer</label>
      <input class="w-full border rounded px-3 py-2" name="customer" value="{{ deal.customer if deal else '' }}" placeholder="Customer name">
    </div>
    <div>
      <label class="text-xs text-slate-500">Stock #</label>
      <input class="w-full border rounded px-3 py-2" name="stock_num" value="{{ deal.stock_num if deal else '' }}">
    </div>

    <div class="md:col-span-2">
      <label class="text-xs text-slate-500">Model</label>
      <input class="w-full border rounded px-3 py-2" name="model" value="{{ deal.model if deal else '' }}" placeholder="e.g., 2024 Explorer">
    </div>
    <div>
      <label class="text-xs text-slate-500">New/Used</label>
      <select class="w-full border rounded px-3 py-2" name="new_used">
        {% for s in ["","New","Used"] %}
          <option value="{{ s }}" {% if deal and deal.new_used==s %}selected{% endif %}>{{ s or "—" }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="text-xs text-slate-500">F/C/L</label>
      <select class="w-full border rounded px-3 py-2" name="deal_type">
        {% set cur = (deal.deal_type if deal and deal.deal_type else "") %}
        {# Back-compat for old saved values: F/C/L #}
        {% if cur == "F" %}{% set cur = "Finance" %}{% endif %}
        {% if cur == "C" %}{% set cur = "Cash/Sub-Vented" %}{% endif %}
        {% if cur == "L" %}{% set cur = "Lease" %}{% endif %}

        <option value="" {% if cur=="" %}selected{% endif %}>--</option>
        {% for opt in ["Finance","Cash/Sub-Vented","Lease"] %}
          <option value="{{ opt }}" {% if cur==opt %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="text-xs text-slate-500">F&I</label>
      <select class="w-full border rounded px-3 py-2" name="business_manager">
        {% set cur_bm = (deal.business_manager if deal and deal.business_manager else "") %}
        <option value="" {% if cur_bm=="" %}selected{% endif %}>--</option>
        {% for opt in ["RGO","KMC","DAB","JGA"] %}
          <option value="{{ opt }}" {% if cur_bm==opt %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </div>
    {# Pay Date + Mark as Paid intentionally removed from New Deal screen (handled elsewhere) #}


    <div>
      <label class="text-xs text-slate-500">Discount</label>
      <select class="w-full border rounded px-3 py-2" name="discount_gt_200">
        {% for s in ["No","Yes"] %}
          <option value="{{ s }}" {% if deal and deal.discount_gt_200==s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
      <div class="text-xs text-slate-400 mt-1">Unit comm = {{ settings.unit_comm_discount_le_200 }} (No) / {{ settings.unit_comm_discount_gt_200 }} (Yes)</div>
    </div>

    <div>
      <label class="text-xs text-slate-500">Aim Presentation</label>
      <select class="w-full border rounded px-3 py-2" name="aim_presentation">
        {% set cur_aim = (deal.aim_presentation if deal and deal.aim_presentation else "X") %}
        {% for opt in ["Yes","No","X"] %}
          <option value="{{ opt }}" {% if cur_aim == opt %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      <div class="text-xs text-slate-400 mt-1">X = excluded from Aim %</div>
    </div>

    <div>
      <label class="text-xs text-slate-500">Money Held?</label>
      <input type="number" step="0.01" class="w-full border rounded px-3 py-2" name="hold_amount" value="{{ deal.hold_amount if deal else 0 }}">
      <div class="text-xs text-slate-400 mt-1">Trade hold comm = floor(Hold/1000)*100</div>
    </div>

    <div>
      <label class="text-xs text-slate-500">Comments</label>
      <input class="w-full border rounded px-3 py-2" name="notes" value="{{ deal.notes if deal else '' }}">
    </div>
  </div>

  <script>
    // Spot => Delivered today, and also flip Status to Delivered for you.
    (function () {
      const spot = document.querySelector('input[name="spot_sold"]');
      const status = document.querySelector('select[name="status"]');
      if (!spot || !status) return;

      spot.addEventListener('change', () => {
        if (spot.checked) {
          status.value = 'Delivered';
        } else {
          // If it was auto-set, kick it back to Pending.
          if (status.value === 'Delivered') status.value = 'Pending';
        }
      });
    })();
  </script>

  <div class="mt-5">
    <div class="font-bold mb-2">Add-ons (1/0)</div>
    <div class="grid md:grid-cols-3 gap-3">
      {% set flags = [
        ("permaplate","PermaPlate", settings.permaplate),
        ("nitro_fill","Nitro Fill", settings.nitro_fill),
        ("pulse","Pulse", settings.pulse),
        ("warranty","Warranty", settings.warranty),
        ("tire_wheel","Tire & Wheel", settings.tire_wheel),
      ] %}
      {% for name,label,val in flags %}
        <label class="flex items-center gap-2 bg-slate-50 border rounded p-2">
          <input type="checkbox" name="{{ name }}" value="1" {% if (deal and getattr(deal,name)) or (not deal and name in ["permaplate","nitro_fill","pulse"]) %}checked{% endif %}>
          <span class="text-sm">{{ label }}</span>
          <span class="ml-auto text-xs text-slate-500">${{ val }}</span>
        </label>
      {% endfor %}
    </div>
    <div class="text-xs text-slate-400 mt-2">Finance (Non-Subvented) is now counted automatically when F/C/L = <b>Finance</b>.</div>
  </div>

  <div class="mt-5 flex items-center gap-3">
    <button class="px-4 py-2 rounded bg-slate-900 text-white">Save</button>
    <a class="px-4 py-2 rounded border" href="/deals">Cancel</a>
    {% if deal %}
      <form method="post" action="/deals/{{ deal.id }}/delete" class="ml-auto">
        <button class="px-4 py-2 rounded bg-rose-600 text-white" formmethod="post" formaction="/deals/{{ deal.id }}/delete">Delete</button>
      </form>
    {% endif %}
  </div>

  {% if deal %}
    <div class="mt-4 text-sm text-slate-500">
      Current calc: Unit <b>${{ "{:,.0f}".format(deal.unit_comm or 0) }}</b> +
      Add-ons <b>${{ "{:,.0f}".format(deal.add_ons or 0) }}</b> +
      Trade Hold <b>${{ "{:,.0f}".format(deal.trade_hold_comm or 0) }}</b>
      = <b>${{ "{:,.0f}".format(deal.total_deal_comm or 0) }}</b>
    </div>
  {% endif %}
</form>
{% endblock %}
