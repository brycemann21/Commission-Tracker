{% extends "base.html" %}
{% block content %}
<h1 class="text-xl font-bold mb-1">{{ "Edit Deal" if deal else "New Deal" }}</h1>
<div class="text-sm text-slate-500 mb-4">
  Matches your Excel payplan: Unit commission + add-ons + trade hold commission.
</div>

<form class="bg-white rounded border border-slate-200 p-4" method="post" action="/deals/save">
  {% if deal %}<input type="hidden" name="deal_id" value="{{ deal.id }}">{% endif %}

  <div class="grid md:grid-cols-3 gap-4">
    <div>
      <label class="text-xs text-slate-500">Sold Date</label>
      <input type="date" class="w-full border rounded px-3 py-2" name="sold_date" value="{{ deal.sold_date if deal else '' }}">
    </div>
    <div>
      <label class="text-xs text-slate-500">Delivered Date</label>
      <input type="date" class="w-full border rounded px-3 py-2" name="delivered_date" value="{{ deal.delivered_date if deal else '' }}">
    </div>
    <div>
      <label class="text-xs text-slate-500">Status</label>
      <select class="w-full border rounded px-3 py-2" name="status">
        {% for s in ["Pending","Delivered","Dead"] %}
          <option value="{{ s }}" {% if deal and deal.status==s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
  <label class="text-xs text-slate-500">Tag</label>
  <select class="w-full border rounded px-3 py-2" name="tag">
    {% set current_tag = (deal.tag if deal and deal.tag else "Inbound") %}
    {% for t in ["Inbound","Shop","Title","FO"] %}
      <option value="{{ t }}" {% if current_tag == t %}selected{% endif %}>{{ t }}</option>
    {% endfor %}
  </select>
</div>

    <div class="md:col-span-2">
      <label class="text-xs text-slate-500">Customer</label>
      <input class="w-full border rounded px-3 py-2" name="customer" value="{{ deal.customer if deal else '' }}" placeholder="Customer name">
    </div>
    <div>
      <label class="text-xs text-slate-500">Stock #</label>
      <input class="w-full border rounded px-3 py-2" name="stock_num" value="{{ deal.stock_num if deal else '' }}">
    </div>

    <div class="md:col-span-2">
      <label class="text-xs text-slate-500">Model</label>
      <input class="w-full border rounded px-3 py-2" name="model" value="{{ deal.model if deal else '' }}" placeholder="e.g., 2024 Explorer">
    </div>
    <div>
      <label class="text-xs text-slate-500">New/Used</label>
      <select class="w-full border rounded px-3 py-2" name="new_used">
        {% for s in ["","New","Used"] %}
          <option value="{{ s }}" {% if deal and deal.new_used==s %}selected{% endif %}>{{ s or "â€”" }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="text-xs text-slate-500">Deal Type (F/C/L)</label>
      <input class="w-full border rounded px-3 py-2" name="deal_type" value="{{ deal.deal_type if deal else '' }}">
    </div>
    <div>
      <label class="text-xs text-slate-500">Business Manager</label>
      <input class="w-full border rounded px-3 py-2" name="business_manager" value="{{ deal.business_manager if deal else '' }}">
    </div>
    <div>
      <label class="text-xs text-slate-500">Pay Date (Fri)</label>
      <input type="date" class="w-full border rounded px-3 py-2" name="pay_date" value="{{ deal.pay_date if deal else '' }}">
    </div>

    <div>
      <label class="text-xs text-slate-500">Discount &gt; $200?</label>
      <select class="w-full border rounded px-3 py-2" name="discount_gt_200">
        {% for s in ["No","Yes"] %}
          <option value="{{ s }}" {% if deal and deal.discount_gt_200==s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
      <div class="text-xs text-slate-400 mt-1">Unit comm = {{ settings.unit_comm_discount_le_200 }} (No) / {{ settings.unit_comm_discount_gt_200 }} (Yes)</div>
    </div>

    <div>
      <label class="text-xs text-slate-500">Hold ($)</label>
      <input type="number" step="0.01" class="w-full border rounded px-3 py-2" name="hold_amount" value="{{ deal.hold_amount if deal else 0 }}">
      <div class="text-xs text-slate-400 mt-1">Trade hold comm = floor(Hold/1000)*100</div>
    </div>

    <div>
      <label class="text-xs text-slate-500">Notes</label>
      <input class="w-full border rounded px-3 py-2" name="notes" value="{{ deal.notes if deal else '' }}">
    </div>
  </div>

  <div class="mt-5">
    <div class="font-bold mb-2">Add-ons (1/0)</div>
    <div class="grid md:grid-cols-3 gap-3">
      {% set flags = [
        ("permaplate","PermaPlate", settings.permaplate),
        ("nitro_fill","Nitro Fill", settings.nitro_fill),
        ("pulse","Pulse", settings.pulse),
        ("finance_non_subvented","Finance (Non-Subvented)", settings.finance_non_subvented),
        ("warranty","Warranty", settings.warranty),
        ("tire_wheel","Tire & Wheel", settings.tire_wheel),
      ] %}
      {% for name,label,val in flags %}
        <label class="flex items-center gap-2 bg-slate-50 border rounded p-2">
          <input type="checkbox" name="{{ name }}" value="1" {% if deal and getattr(deal,name) %}checked{% endif %}>
          <span class="text-sm">{{ label }}</span>
          <span class="ml-auto text-xs text-slate-500">${{ val }}</span>
        </label>
      {% endfor %}
    </div>
  </div>

  <div class="mt-5 flex items-center gap-3">
    <button class="px-4 py-2 rounded bg-slate-900 text-white">Save</button>
    <a class="px-4 py-2 rounded border" href="/deals">Cancel</a>
    {% if deal %}
      <form method="post" action="/deals/{{ deal.id }}/delete" class="ml-auto">
        <button class="px-4 py-2 rounded bg-rose-600 text-white" formmethod="post" formaction="/deals/{{ deal.id }}/delete">Delete</button>
      </form>
    {% endif %}
  </div>

  {% if deal %}
    <div class="mt-4 text-sm text-slate-500">
      Current calc: Unit <b>${{ "{:,.0f}".format(deal.unit_comm or 0) }}</b> +
      Add-ons <b>${{ "{:,.0f}".format(deal.add_ons or 0) }}</b> +
      Trade Hold <b>${{ "{:,.0f}".format(deal.trade_hold_comm or 0) }}</b>
      = <b>${{ "{:,.0f}".format(deal.total_deal_comm or 0) }}</b>
    </div>
  {% endif %}
</form>
{% endblock %}
