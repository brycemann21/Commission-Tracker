{% extends "base.html" %}
{% block content %}

{# ‚îÄ‚îÄ Milestone banner ‚îÄ‚îÄ #}
{% if milestones %}
<div class="mb-4 bg-emerald-50 border border-emerald-200 rounded-lg p-3">
  {% for m in milestones %}
    <div class="flex items-center gap-2 text-sm font-medium text-emerald-800 {% if not loop.first %}mt-1{% endif %}">
      <span>üéâ</span> {{ m }}
    </div>
  {% endfor %}
</div>
{% endif %}

{# ‚îÄ‚îÄ Today's Deliveries ‚îÄ‚îÄ #}
{% if todays_deliveries %}
<div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
  <div class="flex items-center gap-2 mb-2">
    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
    <span class="text-sm font-bold text-blue-800">Today's Deliveries ({{ todays_deliveries|length }})</span>
  </div>
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
    {% for d in todays_deliveries %}
      <div class="flex items-center gap-3 bg-white rounded-lg px-3 py-2 border border-blue-100">
        <div class="flex-1 min-w-0">
          <div class="font-medium text-sm text-slate-900 truncate">{{ d.customer }}</div>
          <div class="text-xs text-slate-500">#{{ d.stock_num }}{% if d.model %} ¬∑ {{ d.model }}{% endif %}{% if d.business_manager %} ¬∑ {{ d.business_manager }}{% endif %}</div>
        </div>
        {% if d.on_delivery_board and d.gas_ready and d.inspection_ready and d.insurance_ready %}
          <span class="shrink-0 text-[10px] font-bold text-emerald-700 bg-emerald-100 px-2 py-0.5 rounded-full">READY</span>
        {% elif d.on_delivery_board %}
          <span class="shrink-0 text-[10px] font-bold text-amber-700 bg-amber-100 px-2 py-0.5 rounded-full">PREP</span>
        {% else %}
          <a href="/delivery/{{ d.id }}/push" class="shrink-0 text-[10px] font-bold text-blue-700 bg-blue-100 px-2 py-0.5 rounded-full hover:bg-blue-200 transition"
             onclick="event.preventDefault(); fetch('/delivery/{{ d.id }}/push', {method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'}}).then(()=>location.reload());">
            ‚Üí Board
          </a>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{# ‚îÄ‚îÄ Month/Year Selector ‚îÄ‚îÄ #}
<div class="mb-4 bg-white rounded-lg border border-slate-200 p-4">
  <div class="flex flex-wrap items-end justify-between gap-3">
    <div>
      <div class="text-xs text-slate-500">Viewing</div>
      <div class="text-lg font-bold">
        {% for mo in month_options %}{% if mo.num == selected_month %}{{ mo.label }}{% endif %}{% endfor %}
        {{ selected_year }}
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button type="button" id="openGoalModal" class="text-xs px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50 transition flex items-center gap-1">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        Goals
      </button>
      <a href="/reports/export?month={{ month }}" class="text-xs px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50 transition flex items-center gap-1">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        CSV
      </a>
      <form method="get" action="/" class="flex flex-wrap items-end gap-2">
        <select name="month" class="h-9 px-2 rounded border border-slate-300 bg-white text-sm" onchange="this.form.submit()">
          {% for mo in month_options %}
            <option value="{{ mo.num }}" {% if mo.num == selected_month %}selected{% endif %}>{{ mo.label }}</option>
          {% endfor %}
        </select>
        <select name="year" class="h-9 px-2 rounded border border-slate-300 bg-white text-sm" onchange="this.form.submit()">
          {% for y in year_options %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="h-9 px-3 rounded bg-slate-900 text-white text-sm hover:bg-slate-800 transition">Go</button>
      </form>
    </div>
  </div>
</div>

{# ‚îÄ‚îÄ Stat Cards ‚îÄ‚îÄ #}
<div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">

  {# Units MTD #}
  <div class="bg-white rounded-lg border border-slate-200 p-4">
    <div class="text-xs font-medium text-slate-500 uppercase tracking-wide">Units MTD</div>
    <div class="text-3xl font-bold mt-1">{{ units_mtd }}</div>
    <div class="text-xs text-slate-500 mt-1">New: {{ new_mtd }} ¬∑ Used: {{ used_mtd }}</div>
    {% if units_diff != 0 %}
      <div class="text-xs mt-1 flex items-center gap-1 {{ 'text-emerald-600' if units_diff > 0 else 'text-rose-600' }}">
        {% if units_diff > 0 %}‚Üë{% else %}‚Üì{% endif %} {{ units_diff|abs }} vs last month
      </div>
    {% endif %}
    {% set unit_pct = ((units_mtd / goals.unit_goal * 100) | round | int) if goals.unit_goal > 0 else 0 %}
    <div class="mt-2">
      <div class="flex justify-between text-[10px] text-slate-400 mb-0.5">
        <span>Goal: {{ goals.unit_goal }}</span>
        <span>{{ unit_pct }}%</span>
      </div>
      <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
        <div class="h-2 rounded-full transition-all duration-500 {{ 'bg-emerald-500' if unit_pct >= 100 else 'bg-amber-500' if unit_pct >= 60 else 'bg-slate-400' }}" style="width: {{ [unit_pct, 100] | min }}%"></div>
      </div>
    </div>
  </div>

  {# Commission MTD #}
  <div class="bg-white rounded-lg border border-slate-200 p-4">
    <div class="text-xs font-medium text-slate-500 uppercase tracking-wide">Commission MTD</div>
    <div class="text-3xl font-bold mt-1">${{ "{:,.0f}".format(comm_mtd or 0) }}</div>
    <div class="text-xs text-slate-500 mt-1">Avg/deal: ${{ "{:,.0f}".format(avg_per_deal or 0) }}</div>
    {% if comm_diff != 0 %}
      <div class="text-xs mt-1 flex items-center gap-1 {{ 'text-emerald-600' if comm_diff > 0 else 'text-rose-600' }}">
        {% if comm_diff > 0 %}‚Üë{% else %}‚Üì{% endif %} ${{ "{:,.0f}".format(comm_diff|abs) }} vs last month
      </div>
    {% endif %}
    {% set comm_pct = ((comm_mtd / goals.commission_goal * 100) | round | int) if goals.commission_goal > 0 else 0 %}
    <div class="mt-2">
      <div class="flex justify-between text-[10px] text-slate-400 mb-0.5">
        <span>Goal: ${{ "{:,.0f}".format(goals.commission_goal) }}</span>
        <span>{{ comm_pct }}%</span>
      </div>
      <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
        <div class="h-2 rounded-full transition-all duration-500 {{ 'bg-emerald-500' if comm_pct >= 100 else 'bg-amber-500' if comm_pct >= 60 else 'bg-slate-400' }}" style="width: {{ [comm_pct, 100] | min }}%"></div>
      </div>
    </div>
  </div>

  {# Projected #}
  <div class="bg-white rounded-lg border border-slate-200 p-4">
    <div class="text-xs font-medium text-slate-500 uppercase tracking-wide">Projected (w/ Pending)</div>
    <div class="text-3xl font-bold mt-1 text-blue-700">${{ "{:,.0f}".format(proj_comm or 0) }}</div>
    <div class="text-xs text-slate-500 mt-1">{{ pending_in_month_count }} pending ¬∑ {{ proj_units }} proj. units</div>
    {% if bonus_uplift > 0 %}
      <div class="text-xs text-emerald-600 mt-1">+${{ "{:,.0f}".format(bonus_uplift) }} bonus if all close</div>
    {% endif %}
  </div>

  {# Bonus #}
  <button type="button" id="openBonusModal" class="text-left bg-white rounded-lg border border-slate-200 p-4 hover:border-slate-300 hover:shadow-sm transition">
    <div class="text-xs font-medium text-slate-500 uppercase tracking-wide">Total Bonus</div>
    <div class="text-3xl font-bold mt-1 text-violet-700">${{ "{:,.0f}".format(current_bonus_total or 0) }}</div>
    <div class="text-xs text-slate-500 mt-1">Click for breakdown</div>
  </button>
</div>

{# ‚îÄ‚îÄ Secondary stats ‚îÄ‚îÄ #}
<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
  <div class="bg-white rounded-lg border border-slate-200 px-4 py-3">
    <div class="text-xs text-slate-500">Units YTD</div>
    <div class="text-xl font-bold">{{ units_ytd }}</div>
  </div>
  <div class="bg-white rounded-lg border border-slate-200 px-4 py-3">
    <div class="text-xs text-slate-500">Commission YTD</div>
    <div class="text-xl font-bold">${{ "{:,.0f}".format(comm_ytd or 0) }}</div>
  </div>
  <div class="bg-white rounded-lg border border-slate-200 px-4 py-3">
    <div class="text-xs text-slate-500">Paid MTD</div>
    <div class="text-xl font-bold text-emerald-700">${{ "{:,.0f}".format(paid_comm_mtd or 0) }}</div>
  </div>
  <div class="bg-white rounded-lg border border-slate-200 px-4 py-3">
    <div class="text-xs text-slate-500">Pending Pay MTD</div>
    <div class="text-xl font-bold text-amber-700">${{ "{:,.0f}".format(pending_comm_mtd or 0) }}</div>
  </div>
</div>

{# ‚îÄ‚îÄ Next Milestones ‚îÄ‚îÄ #}
{% set vn = bonus_breakdown.volume.next %}
{% set un = bonus_breakdown.used.next %}
{% set sn = bonus_breakdown.spot.next %}
{% set qn = bonus_breakdown.quarterly.next %}
{% if vn.need > 0 or un.need > 0 or sn.need > 0 or qn.need > 0 %}
<div class="mb-4 bg-white rounded-lg border border-amber-200 p-4">
  <div class="text-xs font-semibold text-amber-700 uppercase tracking-wide mb-3 flex items-center gap-1">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
    Next Milestones
  </div>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
    {% if vn.need > 0 %}
    <div class="bg-amber-50 rounded-lg p-3">
      <div class="text-[11px] text-slate-500">Volume Bonus</div>
      <div class="text-lg font-bold text-amber-800">{{ vn.need }} more</div>
      <div class="text-[11px] text-slate-500">‚Üí {{ vn.tier }} = ${{ "{:,.0f}".format(vn.amount) }}</div>
    </div>
    {% endif %}
    {% if un.need > 0 %}
    <div class="bg-amber-50 rounded-lg p-3">
      <div class="text-[11px] text-slate-500">Used Bonus</div>
      <div class="text-lg font-bold text-amber-800">{{ un.need }} more used</div>
      <div class="text-[11px] text-slate-500">‚Üí {{ un.tier }} = ${{ "{:,.0f}".format(un.amount) }}</div>
    </div>
    {% endif %}
    {% if sn.need > 0 %}
    <div class="bg-amber-50 rounded-lg p-3">
      <div class="text-[11px] text-slate-500">Spot Bonus</div>
      <div class="text-lg font-bold text-amber-800">{{ sn.need }} more spots</div>
      <div class="text-[11px] text-slate-500">‚Üí {{ sn.tier }} @ ${{ "{:,.0f}".format(sn.per) }}/spot</div>
    </div>
    {% endif %}
    {% if qn.need > 0 %}
    <div class="bg-amber-50 rounded-lg p-3">
      <div class="text-[11px] text-slate-500">Quarterly ({{ bonus_breakdown.quarterly.q_label }})</div>
      <div class="text-lg font-bold text-amber-800">{{ qn.need }} more units</div>
      <div class="text-[11px] text-slate-500">‚Üí ${{ "{:,.0f}".format(qn.amount) }}</div>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

{# ‚îÄ‚îÄ Closing Rates (color coded) ‚îÄ‚îÄ #}
<div class="mb-4 bg-white rounded-lg border border-slate-200 p-4">
  <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Closing % (Delivered Deals)</div>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    {% for k in ["pulse","nitro","permaplate","aim"] %}
      {% set r = closing_rates[k] %}
      {% set pct = (r.pct if r.pct is not none else 0) %}
      {% set bar_color = 'bg-emerald-500' if r.pct is not none and r.pct >= 60 else 'bg-amber-500' if r.pct is not none and r.pct >= 30 else 'bg-rose-400' if r.pct is not none else 'bg-slate-200' %}
      {% set text_color = 'text-emerald-700' if r.pct is not none and r.pct >= 60 else 'text-amber-700' if r.pct is not none and r.pct >= 30 else 'text-rose-600' if r.pct is not none else 'text-slate-400' %}
      <div>
        <div class="flex items-center justify-between mb-1">
          <div class="text-sm font-medium text-slate-700">{{ r.label }}</div>
          <div class="text-lg font-bold {{ text_color }}">
            {% if r.pct is none %}--{% else %}{{ "{:.0f}".format(r.pct) }}%{% endif %}
          </div>
        </div>
        <div class="h-2.5 bg-slate-100 rounded-full overflow-hidden">
          <div class="h-2.5 rounded-full {{ bar_color }} transition-all duration-500" style="width: {{ pct }}%"></div>
        </div>
        <div class="text-[10px] text-slate-400 mt-1">{{ r.yes }}/{{ r.den }}{% if k == "aim" %} (X excluded){% endif %}</div>
      </div>
    {% endfor %}
  </div>
</div>

{# ‚îÄ‚îÄ Year Trend ‚îÄ‚îÄ #}
<div class="mb-4 bg-white rounded-lg border border-slate-200 p-4">
  <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">{{ year }} Unit Trend</div>
  <div class="flex items-end gap-1" style="height: 120px;">
    {% set max_units = units_by_month | max %}
    {% for i in range(12) %}
      {% set u = units_by_month[i] %}
      {% set h = ((u / max_units * 100) | round | int) if max_units > 0 else 0 %}
      {% set is_current = (i + 1 == selected_month) %}
      <div class="flex-1 flex flex-col items-center justify-end h-full">
        <div class="text-[10px] font-semibold mb-1 {{ 'text-slate-900' if u > 0 else 'text-slate-300' }}">{{ u }}</div>
        <div class="w-full rounded-t {{ 'bg-emerald-500' if is_current else 'bg-slate-300' if u > 0 else 'bg-slate-100' }} transition-all duration-300"
             style="height: {{ [h, 4] | max }}%"></div>
        <div class="text-[10px] mt-1 {{ 'font-bold text-slate-900' if is_current else 'text-slate-400' }}">{{ month_labels[i] }}</div>
      </div>
    {% endfor %}
  </div>
</div>

<style>
  .editable-p { cursor:pointer; border-radius:3px; padding:1px 3px; display:inline-block; transition:background .1s; }
  .editable-p:hover { background:#f1f5f9; }
  .editable-p.editing { background:transparent; padding:0; }
  .editable-p input, .editable-p select { border:1.5px solid #6366f1; border-radius:4px; padding:2px 5px; font-size:.8rem; background:#fff; outline:none; min-width:70px; max-width:140px; }
  .editable-p.save-ok { animation:fok .5s ease; } .editable-p.save-err { animation:ferr .5s ease; }
  @keyframes fok  { 0%,100%{background:transparent} 50%{background:#dcfce7} }
  @keyframes ferr { 0%,100%{background:transparent} 50%{background:#fee2e2} }
</style>

{# ‚îÄ‚îÄ Pending Deals ‚îÄ‚îÄ #}
<div class="flex items-center justify-between mb-2">
  <h2 class="text-lg font-bold">Pending & Scheduled <span class="text-sm font-normal text-slate-500">({{ pending }})</span></h2>
  <div class="flex items-center gap-2">
    <button id="pendingDeleteBtn" type="button" onclick="submitPendingBulkDelete()" class="hidden text-xs px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-700 text-white font-medium transition">
      Delete Selected (<span id="pendingDeleteCount">0</span>)
    </button>
    {% if pending > 0 %}
      <button id="openPendingModal" type="button" class="text-sm text-slate-600 hover:text-slate-900 underline">View all</button>
    {% endif %}
  </div>
</div>

<form id="pendingBulkForm" method="post" action="/deals/bulk-delete">
        {{ csrf_hidden|safe }}
  <input type="hidden" name="redirect" value="/?year={{ selected_year }}&month={{ selected_month }}">
  <div class="overflow-x-auto bg-white rounded-lg border border-slate-200">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-900 text-white">
        <tr>
          <th class="p-2 w-8"><input type="checkbox" id="pendingSelectAll" class="rounded cursor-pointer accent-white" title="Select all"></th>
          <th class="text-left p-2">Sold</th>
          <th class="text-left p-2">Customer</th>
          <th class="text-left p-2">Tag</th>
          <th class="text-left p-2">Stock #</th>
          <th class="text-left p-2">Model</th>
          <th class="text-left p-2">Notes</th>
          <th class="text-left p-2">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for d in pending_deals %}
          <tr class="border-t pending-row {% if d.days_pending >= 7 %}bg-rose-50{% elif d.days_pending >= 3 %}bg-amber-50{% endif %}">
            <td class="p-2">
              <input type="checkbox" name="deal_ids" value="{{ d.id }}" class="pending-checkbox rounded cursor-pointer" onchange="updatePendingSelection()">
            </td>
            <td class="p-2 whitespace-nowrap">
              <span class="editable-p" data-field="sold_date" data-id="{{ d.id }}" data-type="date"
                    data-value="{{ d.sold_date.isoformat() if d.sold_date else '' }}">
                {{ d.sold_date.strftime('%-m/%-d') if d.sold_date else '‚Äî' }}
              </span>
              {% if d.days_pending >= 3 %}
                <span class="ml-1 text-[10px] font-medium {{ 'text-rose-600' if d.days_pending >= 7 else 'text-amber-600' }}">{{ d.days_pending }}d</span>
              {% endif %}
            </td>
            <td class="p-2 font-medium">
              <span class="editable-p" data-field="customer" data-id="{{ d.id }}" data-type="text"
                    data-value="{{ d.customer|e }}">{{ d.customer }}</span>
            </td>
            <td class="p-2">
              <span class="editable-p" data-field="tag" data-id="{{ d.id }}" data-type="select"
                    data-value="{{ d.tag or '' }}" data-options="|Shop|Title|Inbound|FO|SPOT|LOCATE">
                {% if d.tag %}<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-slate-100 text-slate-700">{{ d.tag }}</span>{% else %}‚Äî{% endif %}
              </span>
            </td>
            <td class="p-2">
              <span class="editable-p" data-field="stock_num" data-id="{{ d.id }}" data-type="text"
                    data-value="{{ d.stock_num|e }}">{{ d.stock_num or '‚Äî' }}</span>
            </td>
            <td class="p-2">
              <span class="editable-p" data-field="model" data-id="{{ d.id }}" data-type="text"
                    data-value="{{ d.model|e }}">{{ d.model or '‚Äî' }}</span>
            </td>
            <td class="p-2 text-slate-500 max-w-[160px]">
              <span class="editable-p truncate block" data-field="notes" data-id="{{ d.id }}" data-type="text"
                    data-value="{{ (d.notes or '')|e }}" title="{{ d.notes or '' }}">{{ d.notes or '‚Äî' }}</span>
            </td>
            <td class="p-2 whitespace-nowrap relative" id="status-cell-{{ d.id }}">
              <div class="flex items-center gap-1.5">
                <span id="status-badge-{{ d.id }}" class="inline-block px-1.5 py-0.5 rounded text-[11px] font-semibold
                  {% if d.status == 'Delivered' %}bg-emerald-100 text-emerald-800
                  {% elif d.status == 'Dead' %}bg-slate-100 text-slate-500
                  {% elif d.status == 'Scheduled' %}bg-blue-100 text-blue-800
                  {% else %}bg-amber-100 text-amber-800{% endif %}
                  cursor-pointer hover:opacity-80 transition select-none"
                  onclick="togglePendingStatusDropdown({{ d.id }})">
                  {{ d.status }}{% if d.status == 'Scheduled' and d.scheduled_date %} {{ d.scheduled_date.strftime('%-m/%-d') }}{% endif %}
                </span>
              </div>
              <div id="status-drop-{{ d.id }}" class="hidden absolute z-20 mt-1 bg-white border border-slate-200 rounded-lg shadow-lg py-1 min-w-[120px]">
                {% for st in ['Pending', 'Scheduled', 'Delivered', 'Dead'] %}
                <button type="button" onclick="pendingStatusChange('{{ st }}', {{ d.id }})"
                        class="w-full text-left px-3 py-1.5 text-xs hover:bg-slate-50 transition
                        {% if d.status == st %}font-semibold{% endif %}">
                  {{ st }}
                </button>
                {% endfor %}
              </div>
            </td>
          </tr>
        {% endfor %}
        {% if pending_deals|length == 0 %}
          <tr class="border-t">
            <td class="p-6 text-center text-slate-400" colspan="8">
              No pending deals.
              <a href="/deals/new" class="ml-2 inline-flex items-center gap-1 px-3 py-1 rounded bg-emerald-600 text-white text-xs font-medium hover:bg-emerald-700 transition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Log your first deal
              </a>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</form>

{# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}

{# ‚îÄ‚îÄ Bonus Breakdown Modal ‚îÄ‚îÄ #}
<div id="bonusModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50" id="bonusModalBackdrop"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-lg shadow-lg overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <div>
          <div class="text-sm text-slate-500">Bonus Breakdown</div>
          <div class="text-lg font-semibold">{{ month_options[selected_month-1].label }} {{ selected_year }}</div>
        </div>
        <div class="flex items-center gap-2">
          <button type="button" id="printBonus" class="text-sm px-3 py-1 rounded border border-slate-200 hover:bg-slate-50">Print</button>
          <button type="button" id="closeBonusModal" class="text-slate-500 hover:text-slate-900 text-2xl leading-none">&times;</button>
        </div>
      </div>
      <div class="p-5" id="bonusModalContent">
        <div class="text-2xl font-bold text-slate-900 mb-4">Total: ${{ "{:,.0f}".format(bonus_breakdown.total or 0) }}</div>
        <div class="overflow-x-auto rounded border border-slate-200">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-900 text-white">
              <tr>
                <th class="text-left p-2.5">Bonus</th>
                <th class="text-left p-2.5">Progress</th>
                <th class="text-left p-2.5">Tier</th>
                <th class="text-left p-2.5">Next</th>
                <th class="text-right p-2.5">Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-t">
                <td class="p-2.5 font-medium">Volume Bonus</td>
                <td class="p-2.5">{{ bonus_breakdown.volume.units }} units <span class="text-slate-400">‚Äî {{ bonus_breakdown.volume.new_units }}N / {{ bonus_breakdown.volume.used_units }}U</span></td>
                <td class="p-2.5">{{ bonus_breakdown.volume.tier }}</td>
                <td class="p-2.5">
                  {% set n = bonus_breakdown.volume.next %}
                  {% if n.tier == 'Maxed' %}<span class="text-emerald-600 font-medium">Maxed ‚úì</span>
                  {% else %}{{ n.tier }} ‚Üí ${{ "{:,.0f}".format(n.amount or 0) }} <span class="text-slate-400">(need {{ n.need }})</span>{% endif %}
                </td>
                <td class="p-2.5 text-right font-semibold {{ 'text-emerald-700' if bonus_breakdown.volume.amount > 0 else '' }}">${{ "{:,.0f}".format(bonus_breakdown.volume.amount or 0) }}</td>
              </tr>
              <tr class="border-t">
                <td class="p-2.5 font-medium">Used Volume</td>
                <td class="p-2.5">{{ bonus_breakdown.used.units }} used</td>
                <td class="p-2.5">{{ bonus_breakdown.used.tier }}</td>
                <td class="p-2.5">
                  {% set n = bonus_breakdown.used.next %}
                  {% if n.tier == 'Maxed' %}<span class="text-emerald-600 font-medium">Maxed ‚úì</span>
                  {% else %}{{ n.tier }} ‚Üí ${{ "{:,.0f}".format(n.amount or 0) }} <span class="text-slate-400">(need {{ n.need }})</span>{% endif %}
                </td>
                <td class="p-2.5 text-right font-semibold {{ 'text-emerald-700' if bonus_breakdown.used.amount > 0 else '' }}">${{ "{:,.0f}".format(bonus_breakdown.used.amount or 0) }}</td>
              </tr>
              <tr class="border-t">
                <td class="p-2.5 font-medium">Spot Bonus</td>
                <td class="p-2.5">{{ bonus_breakdown.spot.spots }} spots</td>
                <td class="p-2.5">{{ bonus_breakdown.spot.tier }} @ ${{ "{:,.0f}".format(bonus_breakdown.spot.per or 0) }}/spot</td>
                <td class="p-2.5">
                  {% set n = bonus_breakdown.spot.next %}
                  {% if n.tier == 'Maxed' %}<span class="text-emerald-600 font-medium">Maxed ‚úì</span>
                  {% else %}{{ n.tier }} @ ${{ "{:,.0f}".format(n.per or 0) }}/spot <span class="text-slate-400">(need {{ n.need }})</span>{% endif %}
                </td>
                <td class="p-2.5 text-right font-semibold {{ 'text-emerald-700' if bonus_breakdown.spot.amount > 0 else '' }}">${{ "{:,.0f}".format(bonus_breakdown.spot.amount or 0) }}</td>
              </tr>
              <tr class="border-t">
                <td class="p-2.5 font-medium">Quarterly</td>
                <td class="p-2.5">{{ bonus_breakdown.quarterly.units_qtd }} units ({{ bonus_breakdown.quarterly.q_label }})</td>
                <td class="p-2.5">{{ 'Hit ‚úì' if bonus_breakdown.quarterly.hit else 'Not hit' }} ({{ bonus_breakdown.quarterly.threshold }})</td>
                <td class="p-2.5">
                  {% if bonus_breakdown.quarterly.hit %}<span class="text-emerald-600 font-medium">Hit ‚úì</span>
                  {% else %}{{ bonus_breakdown.quarterly.next.tier }} ‚Üí ${{ "{:,.0f}".format(bonus_breakdown.quarterly.next.amount or 0) }} <span class="text-slate-400">(need {{ bonus_breakdown.quarterly.next.need }})</span>{% endif %}
                </td>
                <td class="p-2.5 text-right font-semibold {{ 'text-emerald-700' if bonus_breakdown.quarterly.amount > 0 else '' }}">${{ "{:,.0f}".format(bonus_breakdown.quarterly.amount or 0) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="text-xs text-slate-400 mt-3">* Bonuses based on Delivered deals for selected month. Quarterly based on Delivered units in the current quarter.</div>
      </div>
    </div>
  </div>
</div>

{# ‚îÄ‚îÄ Pending Modal ‚îÄ‚îÄ #}
<div id="pendingModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50" id="pendingModalBackdrop"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-6xl rounded-lg shadow-lg overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <div>
          <div class="text-sm text-slate-500">Pending Deals</div>
          <div class="text-lg font-semibold">All Pending ({{ pending }})</div>
        </div>
        <div class="flex items-center gap-3">
          <button id="modalDeleteBtn" type="button" onclick="submitModalBulkDelete()" class="hidden text-xs px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-700 text-white font-medium transition">
            Delete Selected (<span id="modalDeleteCount">0</span>)
          </button>
          <button type="button" id="closePendingModal" class="text-slate-500 hover:text-slate-900 text-2xl leading-none">&times;</button>
        </div>
      </div>
      <div class="p-4 overflow-auto" style="max-height: 75vh;">
        <form id="modalBulkForm" method="post" action="/deals/bulk-delete">
        {{ csrf_hidden|safe }}
          <input type="hidden" name="redirect" value="/?year={{ selected_year }}&month={{ selected_month }}">
          <div class="overflow-x-auto bg-white rounded border border-slate-200">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-900 text-white">
                <tr>
                  <th class="p-2 w-8">
                    <input type="checkbox" id="modalSelectAll" class="rounded cursor-pointer accent-white" title="Select all">
                  </th>
                  <th class="text-left p-2">Sold Date</th>
                  <th class="text-left p-2">Customer</th>
                  <th class="text-left p-2">Tag</th>
                  <th class="text-left p-2">Stock #</th>
                  <th class="text-left p-2">Model</th>
                  <th class="text-left p-2">Notes</th>
                  <th class="p-2"></th>
                </tr>
              </thead>
              <tbody>
                {% for d in pending_deals_all %}
                  <tr class="border-t {% if d.days_pending >= 7 %}bg-rose-50{% elif d.days_pending >= 3 %}bg-amber-50{% endif %}">
                    <td class="p-2">
                      <input type="checkbox" name="deal_ids" value="{{ d.id }}" class="modal-checkbox rounded cursor-pointer" onchange="updateModalSelection()">
                    </td>
                    <td class="p-2">{{ d.sold_date or "" }}{% if d.days_pending >= 3 %} <span class="text-[10px] font-medium {{ 'text-rose-600' if d.days_pending >= 7 else 'text-amber-600' }}">{{ d.days_pending }}d</span>{% endif %}</td>
                    <td class="p-2 font-medium">{{ d.customer }}</td>
                    <td class="p-2">{{ d.tag }}</td>
                    <td class="p-2">{{ d.stock_num }}</td>
                    <td class="p-2">{{ d.model }}</td>
                    <td class="p-2">{{ d.notes or "" }}</td>
                    <td class="p-2 text-right whitespace-nowrap">
                      <a class="text-blue-600 hover:underline mr-2 text-xs" href="/deals/{{ d.id }}/edit">Edit</a>
                      <button type="button"
                        onclick="quickAction(this, '/deals/{{ d.id }}/mark_delivered')"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-2.5 py-1 rounded text-xs font-medium">Delivered</button>
                      <button type="button"
                        onclick="quickAction(this, '/deals/{{ d.id }}/mark_dead')"
                        class="bg-rose-600 hover:bg-rose-700 text-white px-2.5 py-1 rounded text-xs font-medium ml-1">Dead</button>
                    </td>
                  </tr>
                {% endfor %}
                {% if pending_deals_all|length == 0 %}
                  <tr class="border-t"><td class="p-3 text-slate-500" colspan="8">No pending deals.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# ‚îÄ‚îÄ Goals Modal ‚îÄ‚îÄ #}
<div id="goalModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50" id="goalModalBackdrop"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-lg shadow-lg overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <div class="text-lg font-semibold">Set Monthly Goals</div>
        <button type="button" id="closeGoalModal" class="text-slate-500 hover:text-slate-900 text-2xl leading-none">&times;</button>
      </div>
      <form method="post" action="/goals/save" class="p-5">
        {{ csrf_hidden|safe }}
        <div class="text-sm text-slate-500 mb-4">{{ month_options[selected_month-1].label }} {{ selected_year }}</div>
        <div class="space-y-3">
          <div>
            <label class="text-xs text-slate-500 block mb-1">Unit Goal</label>
            <input type="number" name="unit_goal" value="{{ goals.unit_goal }}" class="w-full border rounded px-3 py-2" min="0">
          </div>
          <div>
            <label class="text-xs text-slate-500 block mb-1">Commission Goal ($)</label>
            <input type="number" step="100" name="commission_goal" value="{{ goals.commission_goal | int }}" class="w-full border rounded px-3 py-2" min="0">
          </div>
        </div>
        <div class="mt-5 flex justify-end gap-2">
          <button type="button" id="cancelGoalModal" class="px-4 py-2 rounded border text-sm">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded bg-slate-900 text-white text-sm">Save Goals</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# ‚îÄ‚îÄ Bulk Delete Confirmation Modal ‚îÄ‚îÄ #}
<div id="bulkDeleteModal" class="fixed inset-0 z-[60] hidden">
  <div class="absolute inset-0 bg-black/50"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-lg shadow-xl overflow-hidden">
      <div class="px-5 py-4 border-b flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-rose-100 flex items-center justify-center shrink-0">
          <svg class="w-5 h-5 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </div>
        <div>
          <div class="font-semibold text-slate-900">Delete Deals</div>
          <div class="text-xs text-slate-500" id="bulkDeleteSubtitle"></div>
        </div>
      </div>
      <div class="px-5 py-4">
        <p class="text-sm text-slate-600">This will permanently delete <strong id="bulkDeleteCountText"></strong>. This action cannot be undone.</p>
      </div>
      <div class="px-5 py-3 bg-slate-50 border-t flex justify-end gap-2">
        <button type="button" onclick="closeBulkDeleteModal()" class="px-4 py-2 rounded border text-sm hover:bg-slate-100 transition">Cancel</button>
        <button type="button" onclick="confirmBulkDelete()" class="px-4 py-2 rounded bg-rose-600 hover:bg-rose-700 text-white text-sm font-medium transition">Delete</button>
      </div>
    </div>
  </div>
</div>

{# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
<script>
  // ‚îÄ‚îÄ Quick fetch actions (no page reload) ‚îÄ‚îÄ
  function togglePendingStatusDropdown(dealId) {
    // Close all other open dropdowns first
    document.querySelectorAll('[id^="status-drop-"]').forEach(function(d) {
      if (d.id !== 'status-drop-' + dealId) d.classList.add('hidden');
    });
    var drop = document.getElementById('status-drop-' + dealId);
    if (drop) drop.classList.toggle('hidden');
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('[id^="status-cell-"]')) {
      document.querySelectorAll('[id^="status-drop-"]').forEach(function(d){ d.classList.add('hidden'); });
    }
  });

  async function pendingStatusChange(val, dealId) {
    // Close dropdown
    var drop = document.getElementById('status-drop-' + dealId);
    if (drop) drop.classList.add('hidden');

    var badge = document.getElementById('status-badge-' + dealId);
    var prev = badge ? badge.dataset.status || badge.textContent.trim() : 'Pending';

    if (val === 'Scheduled') {
      openSchedModal(dealId, '', false);
      return;
    }

    try {
      var url = val === 'Delivered' ? '/deals/' + dealId + '/mark_delivered'
              : val === 'Dead'      ? '/deals/' + dealId + '/mark_dead'
              : null;
      if (url) {
        await fetch(url, {method:'POST', headers:{'Accept':'application/json'}});
      } else {
        await fetch('/deals/' + dealId + '/quick_update', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({field:'status', value:val})
        });
      }
      window.location.reload();
    } catch(e) {
      console.error(e);
    }
  }

  async function quickAction(btn, url) {
    btn.disabled = true;
    btn.style.opacity = '0.5';
    try {
      const res = await fetch(url, { method: 'POST', headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      if (!data.ok) throw new Error();
      // Remove the row from the pending table instantly
      const row = btn.closest('tr');
      if (row) {
        row.style.transition = 'opacity 0.25s';
        row.style.opacity = '0';
        setTimeout(() => {
          row.remove();
          // Update the pending count badge
          const badge = document.querySelector('h2 .text-slate-500');
          if (badge) {
            const cur = parseInt(badge.textContent.replace(/\D/g,'')) || 0;
            badge.textContent = `(${Math.max(0, cur - 1)})`;
          }
        }, 250);
      }
    } catch {
      btn.disabled = false;
      btn.style.opacity = '';
      btn.textContent = 'Error ‚Äì retry';
      btn.classList.add('bg-red-100', 'text-red-700');
    }
  }

  // ‚îÄ‚îÄ Inline edit for pending deals ‚îÄ‚îÄ
  (function() {
    let active = null;
    function fmtDate(iso) { if(!iso) return '‚Äî'; const p=iso.split('-'); return p.length===3?`${+p[1]}/${+p[2]}`:iso; }
    function render(field, val) {
      if (field==='sold_date') return fmtDate(val);
      if (field==='tag') return val ? `<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-slate-100 text-slate-700">${val}</span>` : '‚Äî';
      return val || '‚Äî';
    }
    async function save(span, field, id, val) {
      try {
        const r = await fetch(`/deals/${id}/quick_update`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({field,value:val})});
        const d = await r.json();
        if (!d.ok) throw 0;
        span.dataset.value = val;
        span.innerHTML = render(field, val);
        span.classList.remove('editing');
        span.classList.add('save-ok');
        setTimeout(()=>span.classList.remove('save-ok'),600);
        active = null;
      } catch {
        span.classList.add('save-err');
        setTimeout(()=>span.classList.remove('save-err'),600);
      }
    }
    function cancel(span) {
      if (!span?._orig) return;
      span.innerHTML = span._orig;
      span.classList.remove('editing');
      if (active===span) active=null;
    }
    function startEdit(span) {
      if (active && active!==span) cancel(active);
      active = span;
      span.classList.add('editing');
      span._orig = span.innerHTML;
      const {field, type='text', value:cur='', id} = span.dataset;
      let inp;
      if (type==='select') {
        inp = document.createElement('select');
        (span.dataset.options||'').split('|').forEach(o=>{const opt=document.createElement('option');opt.value=o;opt.textContent=o||'‚Äî';if(o===cur)opt.selected=true;inp.appendChild(opt);});
      } else {
        inp=document.createElement('input');
        inp.type=type==='date'?'date':'text';
        inp.value=cur;
      }
      span.innerHTML=''; span.appendChild(inp); inp.focus();
      const commit=()=>{const v=inp.value;if(v===cur){cancel(span);return;}save(span,field,id,v);};
      inp.addEventListener('blur',commit);
      inp.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();inp.blur();}if(e.key==='Escape'){e.preventDefault();cancel(span);}});
      if(type==='select') inp.addEventListener('change',()=>inp.blur());
    }
    document.addEventListener('click',e=>{
      const s=e.target.closest('.editable-p');
      if(s&&!s.classList.contains('editing')){startEdit(s);return;}
      if(!s&&active) cancel(active);
    });
  })();

  // ‚îÄ‚îÄ Multi-select pending deals ‚îÄ‚îÄ
  function updatePendingSelection() {
    const checkboxes = document.querySelectorAll('.pending-checkbox');
    const checked = document.querySelectorAll('.pending-checkbox:checked');
    const btn = document.getElementById('pendingDeleteBtn');
    const countSpan = document.getElementById('pendingDeleteCount');
    const selectAll = document.getElementById('pendingSelectAll');

    countSpan.textContent = checked.length;
    btn.classList.toggle('hidden', checked.length === 0);

    // Update select-all state
    if (checked.length === 0) selectAll.indeterminate = false, selectAll.checked = false;
    else if (checked.length === checkboxes.length) selectAll.indeterminate = false, selectAll.checked = true;
    else selectAll.indeterminate = true;
  }

  document.getElementById('pendingSelectAll')?.addEventListener('change', function() {
    document.querySelectorAll('.pending-checkbox').forEach(cb => cb.checked = this.checked);
    updatePendingSelection();
  });

  function submitPendingBulkDelete() {
    const checked = document.querySelectorAll('.pending-checkbox:checked');
    if (checked.length === 0) return;
    const n = checked.length;
    window._activeBulkForm = 'pending';
    document.getElementById('bulkDeleteSubtitle').textContent = `${n} deal${n !== 1 ? 's' : ''} selected`;
    document.getElementById('bulkDeleteCountText').innerHTML = `${n} pending deal${n !== 1 ? 's' : ''}`;
    document.getElementById('bulkDeleteModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  // ‚îÄ‚îÄ Multi-select in View All modal ‚îÄ‚îÄ
  function updateModalSelection() {
    const checkboxes = document.querySelectorAll('.modal-checkbox');
    const checked = document.querySelectorAll('.modal-checkbox:checked');
    const btn = document.getElementById('modalDeleteBtn');
    const countSpan = document.getElementById('modalDeleteCount');
    const selectAll = document.getElementById('modalSelectAll');

    countSpan.textContent = checked.length;
    btn.classList.toggle('hidden', checked.length === 0);

    if (checked.length === 0) { selectAll.indeterminate = false; selectAll.checked = false; }
    else if (checked.length === checkboxes.length) { selectAll.indeterminate = false; selectAll.checked = true; }
    else { selectAll.indeterminate = true; }
  }

  document.getElementById('modalSelectAll')?.addEventListener('change', function() {
    document.querySelectorAll('.modal-checkbox').forEach(cb => cb.checked = this.checked);
    updateModalSelection();
  });

  function submitModalBulkDelete() {
    const checked = document.querySelectorAll('.modal-checkbox:checked');
    if (checked.length === 0) return;
    const n = checked.length;
    window._activeBulkForm = 'modal';
    document.getElementById('bulkDeleteSubtitle').textContent = `${n} deal${n !== 1 ? 's' : ''} selected`;
    document.getElementById('bulkDeleteCountText').innerHTML = `${n} pending deal${n !== 1 ? 's' : ''}`;
    document.getElementById('bulkDeleteModal').classList.remove('hidden');
  }

  function closeBulkDeleteModal() {
    document.getElementById('bulkDeleteModal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  function confirmBulkDelete() {
    closeBulkDeleteModal();
    if (window._activeBulkForm === 'modal') {
      document.getElementById('modalBulkForm').submit();
    } else {
      document.getElementById('pendingBulkForm').submit();
    }
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeBulkDeleteModal();
  });

  function setupModal(openId, modalId, closeId, backdropId) {
    const open = document.getElementById(openId);
    const modal = document.getElementById(modalId);
    const close = document.getElementById(closeId);
    const backdrop = document.getElementById(backdropId);
    if (!modal) return;
    const show = () => { modal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; };
    const hide = () => { modal.classList.add('hidden'); document.body.style.overflow = ''; };
    if (open) open.addEventListener('click', show);
    if (close) close.addEventListener('click', hide);
    if (backdrop) backdrop.addEventListener('click', hide);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hide(); });
    return { show, hide };
  }

  setupModal('openBonusModal', 'bonusModal', 'closeBonusModal', 'bonusModalBackdrop');
  setupModal('openPendingModal', 'pendingModal', 'closePendingModal', 'pendingModalBackdrop');
  const goalModal = setupModal('openGoalModal', 'goalModal', 'closeGoalModal', 'goalModalBackdrop');
  if (goalModal) {
    const cancel = document.getElementById('cancelGoalModal');
    if (cancel) cancel.addEventListener('click', goalModal.hide);
  }

  // Print bonus
  (function() {
    const btn = document.getElementById('printBonus');
    const content = document.getElementById('bonusModalContent');
    if (!btn || !content) return;
    btn.addEventListener('click', () => {
      const w = window.open('', '_blank');
      if (!w) return;
      w.document.write('<html><head><title>Bonus Breakdown</title><style>body{font-family:system-ui;padding:20px}table{width:100%;border-collapse:collapse;margin-top:12px}th,td{border:1px solid #e2e8f0;padding:8px;font-size:13px}th{background:#0f172a;color:white;text-align:left}</style></head><body>' + content.innerHTML + '</body></html>');
      w.document.close(); w.focus(); w.print(); w.close();
    });
  })();
</script>

<!-- ‚îÄ‚îÄ Schedule / Delivery Board Modal (Dashboard) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="dashSchedModal" class="fixed inset-0 z-50 hidden" style="background:rgba(0,0,0,0.5)">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold">Schedule Delivery</h2>
        <button onclick="closeDashSchedModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Scheduled Delivery Date</label>
          <input type="date" id="dashSchedDate"
                 class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
        </div>
        <label class="flex items-center gap-3 cursor-pointer p-3 rounded-lg border border-slate-200 hover:bg-slate-50 transition">
          <input type="checkbox" id="dashSchedBoard" class="rounded w-4 h-4 text-indigo-600">
          <div>
            <div class="text-sm font-medium text-slate-800">Add to Delivery Board</div>
            <div class="text-xs text-slate-500">Track prep status (gas, inspection, insurance)</div>
          </div>
        </label>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="saveDashSched()"
                class="flex-1 px-4 py-2 rounded-lg bg-slate-900 text-white text-sm font-medium hover:bg-slate-700 transition">
          Save
        </button>
        <button onclick="closeDashSchedModal()"
                class="flex-1 px-4 py-2 rounded-lg border border-slate-200 text-slate-600 text-sm font-medium hover:bg-slate-50 transition">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let _dashSchedDealId = null;

function openSchedModal(dealId, currentDate, onBoard) {
  _dashSchedDealId = dealId;
  document.getElementById('dashSchedDate').value = currentDate || new Date().toISOString().split('T')[0];
  document.getElementById('dashSchedBoard').checked = onBoard || false;
  document.getElementById('dashSchedModal').classList.remove('hidden');
  setTimeout(function(){ document.getElementById('dashSchedDate').focus(); }, 50);
}

function closeDashSchedModal() {
  document.getElementById('dashSchedModal').classList.add('hidden');
  _dashSchedDealId = null;
}

async function saveDashSched() {
  if (!_dashSchedDealId) return;
  const date = document.getElementById('dashSchedDate').value;
  const board = document.getElementById('dashSchedBoard').checked;
  try {
    await fetch(`/deals/${_dashSchedDealId}/quick_update`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ field: 'status', value: 'Scheduled' }),
    });
    if (date) {
      await fetch(`/deals/${_dashSchedDealId}/quick_update`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ field: 'scheduled_date', value: date }),
      });
    }
    if (board) {
      const form = new FormData();
      form.append('next', window.location.href);
      await fetch(`/delivery/${_dashSchedDealId}/push`, { method: 'POST', body: form });
    }
    closeDashSchedModal();
    window.location.reload();
  } catch(e) {
    alert('Failed to save. Please try again.');
  }
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDashSchedModal();
});
</script>

{% endblock %}
