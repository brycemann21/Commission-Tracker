{% extends "base.html" %}
{% block content %}

<div class="mb-4 bg-white rounded border border-slate-200 p-4">
  <div class="flex flex-wrap items-end justify-between gap-3">
    <div>
      <div class="text-xs text-slate-500">Viewing</div>
      <div class="text-lg font-bold">
        {% for mo in month_options %}
          {% if mo.num == selected_month %}
            {{ mo.label }}
          {% endif %}
        {% endfor %}
        {{ selected_year }}
      </div>
    </div>

    <form method="get" action="/" class="flex flex-wrap items-end gap-3">
      <div>
        <label class="block text-xs text-slate-500 mb-1">Month</label>
        <select
          name="month"
          class="h-10 px-3 rounded border border-slate-300 bg-white"
          onchange="this.form.submit()"
        >
          {% for mo in month_options %}
            <option value="{{ mo.num }}" {% if mo.num == selected_month %}selected{% endif %}>
              {{ mo.label }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-xs text-slate-500 mb-1">Year</label>
        <select
          name="year"
          class="h-10 px-3 rounded border border-slate-300 bg-white"
          onchange="this.form.submit()"
        >
          {% for y in year_options %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>
              {{ y }}
            </option>
          {% endfor %}
        </select>
      </div>

      <button
        type="submit"
        class="h-10 px-4 rounded bg-slate-900 text-white text-sm hover:bg-slate-800"
      >
        Go
      </button>
    </form>
  </div>
</div>

<div class="grid md:grid-cols-5 gap-4">
  <div class="bg-white rounded border border-slate-200 p-4">
    <div class="text-sm text-slate-500">Units MTD</div>
    <div class="text-3xl font-bold">{{ units_mtd }}</div>
    <div class="text-xs text-slate-500 mt-1">
      New: {{ new_mtd }} Â· Used: {{ used_mtd }}
    </div>
  </div>

  <div class="bg-white rounded border border-slate-200 p-4">
    <div class="text-sm text-slate-500">Commission MTD</div>
    <div class="text-3xl font-bold">
      ${{ "{:,.0f}".format(comm_mtd or 0) }}
    </div>
    <div class="text-xs text-slate-500 mt-2 flex flex-col gap-1">
      <div>Paid: <span class="font-semibold text-slate-900">${{ "{:,.0f}".format(paid_comm_mtd or 0) }}</span></div>
      <div>Pending: <span class="font-semibold text-slate-900">${{ "{:,.0f}".format(pending_comm_mtd or 0) }}</span></div>
    </div>

  </div>

  <button type="button" id="openBonusModal" class="text-left bg-white rounded border border-slate-200 p-4 hover:border-slate-300 hover:shadow-sm transition">
    <div class="text-sm text-slate-500">Current Bonus</div>
    <div class="text-3xl font-bold">
      ${{ "{:,.0f}".format(current_bonus_total or 0) }}
    </div>
    <div class="text-xs text-slate-500 mt-1">Click for breakdown</div>
  </button>

  <div class="bg-white rounded border border-slate-200 p-4">
    <div class="text-sm text-slate-500">Units YTD</div>
    <div class="text-3xl font-bold">{{ units_ytd }}</div>
  </div>

  <div class="bg-white rounded border border-slate-200 p-4">
    <div class="text-sm text-slate-500">Commission YTD</div>
    <div class="text-3xl font-bold">
      ${{ "{:,.0f}".format(comm_ytd or 0) }}
    </div>
  </div>
</div>

<!-- Current Bonus Modal -->
<div id="bonusModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50" id="bonusModalBackdrop"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-lg shadow-lg overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <div>
          <div class="text-sm text-slate-500">Current Bonus Breakdown</div>
          <div class="text-lg font-semibold">{{ month_options[selected_month-1].label }} {{ selected_year }}</div>
        </div>
        <div class="flex items-center gap-2">
          <button type="button" id="printBonus" class="text-sm px-3 py-1 rounded border border-slate-200 hover:bg-slate-50">Print</button>
          <button type="button" id="closeBonusModal" class="text-slate-500 hover:text-slate-900 text-2xl leading-none">&times;</button>
        </div>
      </div>

      <div class="p-5" id="bonusModalContent">
        <div class="text-sm text-slate-600 mb-3">Total: <span class="font-semibold text-slate-900">${{ "{:,.0f}".format(bonus_breakdown.total or 0) }}</span></div>

        <div class="overflow-x-auto rounded border border-slate-200">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-900 text-white">
              <tr>
                <th class="text-left p-2">Bonus</th>
                <th class="text-left p-2">Progress</th>
                <th class="text-left p-2">Tier</th>
                <th class="text-right p-2">Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-t">
                <td class="p-2">New Volume</td>
                <td class="p-2">{{ bonus_breakdown.new.units }} new (MTD)</td>
                <td class="p-2">{{ bonus_breakdown.new.tier }}</td>
                <td class="p-2 text-right">${{ "{:,.0f}".format(bonus_breakdown.new.amount or 0) }}</td>
              </tr>
              <tr class="border-t">
                <td class="p-2">Used Volume</td>
                <td class="p-2">{{ bonus_breakdown.used.units }} used (MTD)</td>
                <td class="p-2">{{ bonus_breakdown.used.tier }}</td>
                <td class="p-2 text-right">${{ "{:,.0f}".format(bonus_breakdown.used.amount or 0) }}</td>
              </tr>
              <tr class="border-t">
                <td class="p-2">Spot Bonus</td>
                <td class="p-2">{{ bonus_breakdown.spot.spots }} spots (MTD)</td>
                <td class="p-2">{{ bonus_breakdown.spot.tier }} @ ${{ "{:,.0f}".format(bonus_breakdown.spot.per or 0) }}/spot</td>
                <td class="p-2 text-right">${{ "{:,.0f}".format(bonus_breakdown.spot.amount or 0) }}</td>
              </tr>
              <tr class="border-t">
                <td class="p-2">Quarterly</td>
                <td class="p-2">{{ bonus_breakdown.quarterly.units_qtd }} units ({{ bonus_breakdown.quarterly.q_label }} to date)</td>
                <td class="p-2">{{ 'Hit' if bonus_breakdown.quarterly.hit else 'Not hit' }} ({{ bonus_breakdown.quarterly.threshold }})</td>
                <td class="p-2 text-right">${{ "{:,.0f}".format(bonus_breakdown.quarterly.amount or 0) }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="text-xs text-slate-500 mt-3">
          * Bonuses are calculated from Delivered deals for the selected month (MTD). Quarterly is based on Delivered units in the current quarter.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mt-6 bg-white rounded border border-slate-200 p-4">
  <div class="text-sm text-slate-500 mb-2">{{ year }} Unit Trend</div>
  <div class="grid grid-cols-12 gap-2 text-center text-sm">
    {% for i in range(12) %}
      <div>
        <div class="text-xs text-slate-500">
          {{ month_labels[i] }}
        </div>
        <div class="font-bold text-lg">
          {{ units_by_month[i] }}
        </div>
      </div>
    {% endfor %}
  </div>

</div>

<div class="mt-6 bg-white rounded border border-slate-200 p-4">
  <div class="text-sm text-slate-500 mb-3">Closing % (Delivered Deals)</div>

  <div class="space-y-3">
    {% for k in ["pulse","nitro","permaplate","aim"] %}
      {% set r = closing_rates[k] %}
      {% set pct = (r.pct if r.pct is not none else 0) %}
      <div>
        <div class="flex items-center justify-between text-sm mb-1">
          <div class="font-medium text-slate-800">{{ r.label }}</div>
          <div class="text-slate-600">
            {% if r.pct is none %}
              --
            {% else %}
              {{ "{:.1f}".format(r.pct) }}%
            {% endif %}
            <span class="text-xs text-slate-400 ml-2">({{ r.yes }}/{{ r.den }})</span>
          </div>
        </div>
        <div class="h-3 bg-slate-200 rounded overflow-hidden">
          <div class="h-3 bg-slate-900 rounded" style="width: {{ pct }}%"></div>
        </div>
        {% if k == "aim" %}
          <div class="text-xs text-slate-400 mt-1">Aim % counts Yes/No only. X is excluded.</div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<div class="mt-6 flex items-center justify-between">
  <h2 class="text-lg font-bold">Pending Deals</h2>
  <button id="openPendingModal" type="button" class="text-sm underline">View all</button>
</div>

<div class="mt-2 overflow-x-auto bg-white rounded border border-slate-200">
  <table class="min-w-full text-sm">
    <thead class="bg-slate-900 text-white">
      <tr>
        <th class="text-left p-2">Sold Date</th>
        <th class="text-left p-2">Customer Name</th>
        <th class="text-left p-2">Tag</th>
        <th class="text-left p-2">Stock #</th>
        <th class="text-left p-2">Model</th>
        <th class="text-left p-2">Notes</th>
        <th class="p-2"></th>
      </tr>
    </thead>
    <tbody>
      {% for d in pending_deals %}
        <tr class="border-t
          {% if d.days_pending >= 7 %}
            bg-rose-100
          {% elif d.days_pending >= 3 %}
            bg-amber-100
          {% endif %}
        ">
          <td class="p-2">{{ d.sold_date or "" }}</td>
          <td class="p-2">{{ d.customer }}</td>
          <td class="p-2">{{ d.tag }}</td>
          <td class="p-2">{{ d.stock_num }}</td>
          <td class="p-2">{{ d.model }}</td>
          <td class="p-2">{{ d.notes or "" }}</td>
          <td class="p-2 text-right whitespace-nowrap">
            <a class="underline mr-2" href="/deals/{{ d.id }}/edit">Edit</a>
            <form method="post" action="/deals/{{ d.id }}/mark_delivered" class="inline">
              <input type="hidden" name="redirect" value="/?month={{ month }}">
              <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded mr-1" type="submit">
                Delivered
              </button>
            </form>
            <form method="post" action="/deals/{{ d.id }}/mark_dead" class="inline">
              <input type="hidden" name="redirect" value="/?month={{ month }}">
              <button class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 rounded" type="submit">
                Dead
              </button>
            </form>
          </td>
        </tr>
      {% endfor %}
      {% if pending_deals|length == 0 %}
        <tr class="border-t">
          <td class="p-3 text-slate-500" colspan="7">No pending deals.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- View All Pending Modal -->
<div id="pendingModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50" id="pendingModalBackdrop"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-6xl rounded-lg shadow-lg overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <div>
          <div class="text-sm text-slate-500">Pending Deals</div>
          <div class="text-lg font-semibold">All Pending</div>
        </div>
        <button type="button" id="closePendingModal" class="text-slate-500 hover:text-slate-900 text-2xl leading-none">&times;</button>
      </div>

      <div class="p-4 overflow-auto" style="max-height: 75vh;">
        <div class="overflow-x-auto bg-white rounded border border-slate-200">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-900 text-white">
              <tr>
                <th class="text-left p-2">Sold Date</th>
                <th class="text-left p-2">Customer</th>
                <th class="text-left p-2">Tag</th>
                <th class="text-left p-2">Stock #</th>
                <th class="text-left p-2">Model</th>
                <th class="text-left p-2">Notes</th>
                <th class="p-2"></th>
              </tr>
            </thead>
            <tbody>
              {% for d in pending_deals_all %}
                <tr class="border-t
                  {% if d.days_pending >= 7 %}
                    bg-rose-100
                  {% elif d.days_pending >= 3 %}
                    bg-amber-100
                  {% endif %}
                ">
                  <td class="p-2">{{ d.sold_date or "" }}</td>
                  <td class="p-2">{{ d.customer }}</td>
                  <td class="p-2">{{ d.tag }}</td>
                  <td class="p-2">{{ d.stock_num }}</td>
                  <td class="p-2">{{ d.model }}</td>
                  <td class="p-2">{{ d.notes or "" }}</td>
                  <td class="p-2 text-right whitespace-nowrap">
                    <a class="underline mr-2" href="/deals/{{ d.id }}/edit">Edit</a>
                    <form method="post" action="/deals/{{ d.id }}/mark_delivered" class="inline">
                      <input type="hidden" name="redirect" value="/?month={{ month }}">
                      <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded mr-1" type="submit">Delivered</button>
                    </form>
                    <form method="post" action="/deals/{{ d.id }}/mark_dead" class="inline">
                      <input type="hidden" name="redirect" value="/?month={{ month }}">
                      <button class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 rounded" type="submit">Dead</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              {% if pending_deals_all|length == 0 %}
                <tr class="border-t">
                  <td class="p-3 text-slate-500" colspan="7">No pending deals.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const openBtn = document.getElementById('openPendingModal');
    const modal = document.getElementById('pendingModal');
    const closeBtn = document.getElementById('closePendingModal');
    const backdrop = document.getElementById('pendingModalBackdrop');

    function open() {
      if (!modal) return;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function close() {
      if (!modal) return;
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    if (openBtn) openBtn.addEventListener('click', open);
    if (closeBtn) closeBtn.addEventListener('click', close);
    if (backdrop) backdrop.addEventListener('click', close);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });
  })();
</script>

<script>
  (function () {
    const openBtn = document.getElementById('openBonusModal');
    const modal = document.getElementById('bonusModal');
    const closeBtn = document.getElementById('closeBonusModal');
    const backdrop = document.getElementById('bonusModalBackdrop');
    const printBtn = document.getElementById('printBonus');
    const content = document.getElementById('bonusModalContent');

    function open() {
      if (!modal) return;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function close() {
      if (!modal) return;
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function print() {
      if (!content) return;
      const w = window.open('', '_blank');
      if (!w) return;
      w.document.write(`
        <html>
          <head>
            <title>Bonus Breakdown</title>
            <style>
              body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; padding: 20px; }
              table { width: 100%; border-collapse: collapse; margin-top: 12px; }
              th, td { border: 1px solid #e2e8f0; padding: 8px; font-size: 13px; }
              th { background: #0f172a; color: white; text-align: left; }
              .muted { color: #64748b; font-size: 12px; }
            </style>
          </head>
          <body>
            ${content.innerHTML}
          </body>
        </html>
      `);
      w.document.close();
      w.focus();
      w.print();
      w.close();
    }

    if (openBtn) openBtn.addEventListener('click', open);
    if (closeBtn) closeBtn.addEventListener('click', close);
    if (backdrop) backdrop.addEventListener('click', close);
    if (printBtn) printBtn.addEventListener('click', print);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });
  })();
</script>

{% endblock %}
