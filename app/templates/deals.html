{% extends "base.html" %}
{% block content %}

<style>
  @media print {
    body * { visibility: hidden !important; }
  }

  .editable {
    cursor: pointer;
    border-radius: 4px;
    padding: 2px 4px;
    min-width: 28px;
    display: inline-block;
    transition: background 0.12s;
  }
  .editable:hover { background: #f1f5f9; }
  .editable.editing { background: transparent; padding: 0; }
  .editable input, .editable select {
    border: 1.5px solid #6366f1;
    border-radius: 4px;
    padding: 2px 5px;
    font-size: 0.82rem;
    background: #fff;
    outline: none;
    min-width: 70px;
    max-width: 160px;
  }
  .editable.save-ok { animation: flash-green 0.6s ease; }
  .editable.save-err { animation: flash-red 0.6s ease; }
  @keyframes flash-green { 0%,100% { background: transparent; } 50% { background: #dcfce7; } }
  @keyframes flash-red   { 0%,100% { background: transparent; } 50% { background: #fee2e2; } }

  /* Keep table layout on all screen sizes — horizontal scroll on mobile */
  .deals-table { table-layout: auto; }
  @media (max-width: 767px) {
    .deals-table { font-size: 0.72rem; }
    .deals-table th, .deals-table td { padding: 4px 5px; }
    .deals-table .editable { padding: 1px 2px; }
  }
</style>

<div class="flex flex-col md:flex-row md:items-end gap-3 mb-4">
  <div>
    <h1 class="text-xl font-bold">Deals</h1>
    <div class="text-xs text-slate-500">{{ selected_month }}/{{ selected_year }} · Shows deals sold <em>or</em> delivered this month · <span class="text-violet-600 font-medium">↪ carry</span> = sold prior month, delivered this month · Click any cell to edit inline</div>
  </div>
  <form class="md:ml-auto flex flex-wrap gap-2" method="get" action="/deals">
    <input class="border rounded px-3 py-2 text-sm flex-1 min-w-[150px]" name="q" value="{{ q }}" placeholder="Search customer / stock / model" />
    <select class="border rounded px-3 py-2 text-sm" name="status">
      {% for s in ["All","Pending","Scheduled","Delivered","Dead"] %}
        <option value="{{ s }}" {% if status==s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
    <select class="border rounded px-3 py-2 text-sm" name="paid">
      <option value="All" {% if paid=="All" %}selected{% endif %}>All</option>
      <option value="Paid" {% if paid=="Paid" %}selected{% endif %}>Paid</option>
      <option value="Pending" {% if paid=="Pending" %}selected{% endif %}>Pending Pay</option>
    </select>
    <button class="px-3 py-2 text-sm rounded bg-slate-900 text-white">Go</button>
  </form>
</div>

<form method="post" action="/deals/bulk-delete" id="bulkForm">
<div id="bulkToolbar" class="hidden mb-3 flex flex-wrap items-center gap-3 p-3 bg-red-50 border border-red-200 rounded-lg">
  <span id="bulkCount" class="text-sm font-medium text-red-700">0 deals selected</span>
  <button type="submit" onclick="return confirm('Permanently delete selected deals?')"
          class="px-4 py-1.5 rounded bg-red-600 text-white text-sm font-medium hover:bg-red-700 transition">Delete Selected</button>
  <button type="button" onclick="clearSelection()"
          class="px-3 py-1.5 rounded border border-red-300 text-red-600 text-sm hover:bg-red-100 transition">Cancel</button>
</div>

<div class="overflow-x-auto bg-white rounded-lg border border-slate-200">
<table class="min-w-full text-sm deals-table">
  <thead class="bg-slate-900 text-white">
    <tr>
      <th class="p-2 w-8"><input type="checkbox" id="selectAll" class="rounded" title="Select all"></th>
      <th class="text-left p-2">Sold</th>
      <th class="text-left p-2">Del'd</th>
      <th class="text-left p-2">Customer</th>
      <th class="text-left p-2">F&amp;I</th>
      <th class="text-left p-2">Stock #</th>
      <th class="text-left p-2">Model</th>
      <th class="text-left p-2">F/C/L</th>
      <th class="text-left p-2">N/U</th>
      <th class="text-left p-2">Comments</th>
      <th class="text-left p-2">Status</th>
      <th class="text-left p-2">Tag</th>
      <th class="text-right p-2">Commission</th>
      <th class="p-2 w-14"></th>
    </tr>
  </thead>
  <tbody>
    {% for d in deals %}
    <tr class="border-t deal-row hover:bg-slate-50/70 {% if d.status == 'Dead' %}opacity-60{% endif %}" data-id="{{ d.id }}">

      <td class="p-2 checkbox-cell no-label">
        <input type="checkbox" name="deal_ids" value="{{ d.id }}" class="deal-checkbox rounded" onchange="updateBulkToolbar()">
      </td>

      <td class="p-2 whitespace-nowrap" data-label="Sold">
        <span class="editable" data-field="sold_date" data-id="{{ d.id }}" data-type="date"
              data-value="{{ d.sold_date.isoformat() if d.sold_date else '' }}">
          {{ d.sold_date.strftime('%-m/%-d') if d.sold_date else '—' }}
        </span>
        {% if d.sold_date and (d.sold_date.month != selected_month or d.sold_date.year != selected_year) %}
          <span class="ml-1 text-[10px] font-semibold px-1.5 py-0.5 rounded-full bg-violet-100 text-violet-700" title="Sold {{ d.sold_date.strftime('%-m/%-d') }}, delivered this month">↪ carry</span>
        {% endif %}
      </td>

      <td class="p-2 whitespace-nowrap" data-label="Delivered">
        <span class="editable" data-field="delivered_date" data-id="{{ d.id }}" data-type="date"
              data-value="{{ d.delivered_date.isoformat() if d.delivered_date else '' }}">
          {{ d.delivered_date.strftime('%-m/%-d') if d.delivered_date else '—' }}
        </span>
      </td>

      <td class="p-2" data-label="Customer">
        <span class="editable font-medium" data-field="customer" data-id="{{ d.id }}" data-type="text"
              data-value="{{ d.customer|e }}">{{ d.customer }}</span>
      </td>

      <td class="p-2" data-label="F&I">
        <span class="editable" data-field="business_manager" data-id="{{ d.id }}" data-type="select"
              data-value="{{ d.business_manager or '' }}" data-options="|RGO|KMC|DAB|JGA">
          {{ d.business_manager or '—' }}
        </span>
      </td>

      <td class="p-2" data-label="Stock #">
        <span class="editable" data-field="stock_num" data-id="{{ d.id }}" data-type="text"
              data-value="{{ d.stock_num|e }}">{{ d.stock_num or '—' }}</span>
      </td>

      <td class="p-2" data-label="Model">
        <span class="editable" data-field="model" data-id="{{ d.id }}" data-type="text"
              data-value="{{ d.model|e }}">{{ d.model or '—' }}</span>
      </td>

      <td class="p-2" data-label="F/C/L">
        <span class="editable" data-field="deal_type" data-id="{{ d.id }}" data-type="select"
              data-value="{{ d.deal_type or '' }}" data-options="|Finance|Cash/Sub-Vented|Lease">
          {{ d.deal_type or '—' }}
        </span>
      </td>

      <td class="p-2" data-label="N/U">
        <span class="editable" data-field="new_used" data-id="{{ d.id }}" data-type="select"
              data-value="{{ d.new_used or '' }}" data-options="|New|Used">
          {{ d.new_used or '—' }}
        </span>
      </td>

      <td class="p-2 max-w-[180px]" data-label="Comments">
        <span class="editable truncate block" data-field="notes" data-id="{{ d.id }}" data-type="text"
              data-value="{{ (d.notes or '')|e }}" title="{{ d.notes or '' }}">
          {{ d.notes or '—' }}
        </span>
      </td>

      <td class="p-2" data-label="Status">
        <span class="editable" data-field="status" data-id="{{ d.id }}" data-type="select"
              data-value="{{ d.status }}" data-options="Pending|Scheduled|Delivered|Dead">
          <span class="inline-block px-1.5 py-0.5 rounded text-[11px] font-semibold
            {% if d.status == 'Delivered' %}bg-emerald-100 text-emerald-800
            {% elif d.status == 'Dead' %}bg-slate-100 text-slate-500
            {% elif d.status == 'Scheduled' %}bg-blue-100 text-blue-800
            {% else %}bg-amber-100 text-amber-800{% endif %}">
            {{ d.status }}
          </span>
        </span>
      </td>

      <td class="p-2" data-label="Tag">
        <span class="editable" data-field="tag" data-id="{{ d.id }}" data-type="select"
              data-value="{{ d.tag or '' }}" data-options="|Shop|Title|Inbound|FO|SPOT|LOCATE">
          {{ d.tag or '—' }}
        </span>
      </td>

      <td class="p-2 text-right whitespace-nowrap" data-label="Commission">
        <span class="editable" data-field="commission_override" data-id="{{ d.id }}" data-type="number"
              data-value="{{ d.commission_override if d.commission_override is not none else '' }}">
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border text-sm font-semibold
            {% if d.is_paid %}bg-emerald-50 border-emerald-200 text-emerald-800{% else %}bg-white border-slate-200 text-slate-900{% endif %}">
            ${{ "{:,.0f}".format(d.total_deal_comm or 0) }}
            {% if d.commission_override is not none %}<span class="text-[9px] text-amber-500">✎</span>{% endif %}
          </span>
        </span>
      </td>

      <td class="p-2 text-right no-label">
        <button type="button"
          data-paid="{{ '1' if d.is_paid else '0' }}"
          onclick="togglePaid(this, {{ d.id }})"
          class="text-[11px] px-1.5 py-0.5 rounded border transition whitespace-nowrap
          {% if d.is_paid %}bg-emerald-50 border-emerald-200 text-emerald-700 hover:bg-emerald-100
          {% else %}bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100{% endif %}">
          {{ "✓ Paid" if d.is_paid else "Pay?" }}
        </button>
      </td>
    </tr>
    {% endfor %}
    {% if not deals %}
    <tr><td colspan="14" class="p-8 text-center text-slate-400">No deals found.</td></tr>
    {% endif %}
  </tbody>
</table>
</div>
</form>

<!-- Toast notifications -->
<div id="saveToast" class="fixed bottom-5 right-5 z-50 hidden px-4 py-2 rounded-lg shadow-lg text-sm font-medium text-white bg-emerald-600">Saved ✓</div>
<div id="errToast"  class="fixed bottom-5 right-5 z-50 hidden px-4 py-2 rounded-lg shadow-lg text-sm font-medium text-white bg-red-600">Failed to save</div>

<script>
(function () {
  let activeEl = null;

  function toast(id, ms = 1400) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove('hidden');
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.add('hidden'), ms);
  }

  function fmtDate(iso) {
    if (!iso) return '—';
    const p = iso.split('-');
    return p.length === 3 ? `${parseInt(p[1])}/${parseInt(p[2])}` : iso;
  }

  function fmtStatus(val) {
    const map = {
      Delivered: 'bg-emerald-100 text-emerald-800',
      Dead: 'bg-slate-100 text-slate-500',
      Scheduled: 'bg-blue-100 text-blue-800',
      Pending: 'bg-amber-100 text-amber-800',
    };
    return `<span class="inline-block px-1.5 py-0.5 rounded text-[11px] font-semibold ${map[val] || 'bg-slate-100 text-slate-600'}">${val}</span>`;
  }

  function renderValue(field, value) {
    if (field === 'sold_date' || field === 'delivered_date') return fmtDate(value);
    if (field === 'status') return fmtStatus(value);
    if (field === 'commission_override') {
      if (!value && value !== 0) return '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border text-sm font-semibold bg-white border-slate-200 text-slate-900">—</span>';
      return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border text-sm font-semibold bg-white border-slate-200 text-slate-900">$${Number(value).toLocaleString()} <span class="text-[9px] text-amber-500">✎</span></span>`;
    }
    return value || '—';
  }

  async function save(span, field, dealId, value) {
    try {
      const res = await fetch(`/deals/${dealId}/quick_update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ field, value }),
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'err');
      span.dataset.value = value;
      span.innerHTML = renderValue(field, value);
      span.classList.add('save-ok');
      setTimeout(() => span.classList.remove('save-ok'), 700);
      toast('saveToast');
      activeEl = null;
    } catch {
      span.classList.add('save-err');
      setTimeout(() => span.classList.remove('save-err'), 700);
      toast('errToast', 2500);
    }
  }

  function cancelEdit(span) {
    if (!span?._orig) return;
    span.innerHTML = span._orig;
    span.classList.remove('editing');
    if (activeEl === span) activeEl = null;
  }

  function startEdit(span) {
    if (activeEl && activeEl !== span) cancelEdit(activeEl);
    activeEl = span;
    span.classList.add('editing');
    span._orig = span.innerHTML;

    const field = span.dataset.field;
    const type  = span.dataset.type;
    const cur   = span.dataset.value ?? '';
    const id    = span.dataset.id;
    let input;

    if (type === 'select') {
      input = document.createElement('select');
      (span.dataset.options || '').split('|').forEach(o => {
        const opt = document.createElement('option');
        opt.value = o; opt.textContent = o || '—';
        if (o === cur) opt.selected = true;
        input.appendChild(opt);
      });
    } else {
      input = document.createElement('input');
      input.type = type === 'date' ? 'date' : type === 'number' ? 'number' : 'text';
      input.value = cur;
      if (type === 'number') { input.min = 0; input.step = 1; input.placeholder = 'Override $'; }
    }

    span.innerHTML = '';
    span.appendChild(input);
    input.focus();
    if (type === 'text') try { input.select(); } catch(_) {}

    const commit = () => {
      const val = input.value;
      if (val === cur) { cancelEdit(span); return; }
      save(span, field, id, val);
    };

    input.addEventListener('blur', commit);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter')  { e.preventDefault(); input.blur(); }
      if (e.key === 'Escape') { e.preventDefault(); cancelEdit(span); }
    });
    if (type === 'select') input.addEventListener('change', () => input.blur());
  }

  document.addEventListener('click', e => {
    const span = e.target.closest('.editable');
    if (span && !span.classList.contains('editing')) { startEdit(span); return; }
    if (!span && activeEl) cancelEdit(activeEl);
  });
})();

// Toggle paid — no page reload
async function togglePaid(btn, dealId) {
  btn.disabled = true; btn.style.opacity = '0.6';
  try {
    const res = await fetch(`/deals/${dealId}/toggle_paid`, { method: 'POST', headers: { 'Accept': 'application/json' } });
    const data = await res.json();
    if (!data.ok) throw 0;
    const paid = data.is_paid;
    btn.dataset.paid = paid ? '1' : '0';
    btn.textContent = paid ? '✓ Paid' : 'Pay?';
    btn.className = `text-[11px] px-1.5 py-0.5 rounded border transition whitespace-nowrap ${paid ? 'bg-emerald-50 border-emerald-200 text-emerald-700 hover:bg-emerald-100' : 'bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100'}`;
    // Also update the commission badge color in same row
    const commBadge = btn.closest('tr')?.querySelector('[data-field="commission_override"] span');
    if (commBadge) {
      commBadge.className = commBadge.className.replace(/bg-emerald-50 border-emerald-200 text-emerald-800|bg-white border-slate-200 text-slate-900/g, '');
      commBadge.classList.add(...(paid ? ['bg-emerald-50','border-emerald-200','text-emerald-800'] : ['bg-white','border-slate-200','text-slate-900']));
    }
  } catch {
    btn.textContent = 'Error';
  } finally { btn.disabled = false; btn.style.opacity = ''; }
}

// Bulk select
const selectAll = document.getElementById('selectAll');
const bulkToolbar = document.getElementById('bulkToolbar');
const bulkCount = document.getElementById('bulkCount');
function updateBulkToolbar() {
  const checked = document.querySelectorAll('.deal-checkbox:checked');
  bulkToolbar?.classList.toggle('hidden', !checked.length);
  if (bulkCount) bulkCount.textContent = `${checked.length} deal${checked.length !== 1 ? 's' : ''} selected`;
  if (selectAll) {
    const all = document.querySelectorAll('.deal-checkbox');
    selectAll.checked = all.length > 0 && checked.length === all.length;
    selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
  }
}
function clearSelection() {
  document.querySelectorAll('.deal-checkbox').forEach(cb => cb.checked = false);
  if (selectAll) selectAll.checked = false;
  bulkToolbar?.classList.add('hidden');
}
if (selectAll) selectAll.addEventListener('change', () => {
  document.querySelectorAll('.deal-checkbox').forEach(cb => cb.checked = selectAll.checked);
  updateBulkToolbar();
});

const params = new URLSearchParams(window.location.search);
if (params.get('deleted')) {
  const n = document.createElement('div');
  n.className = 'mb-3 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-sm font-medium';
  n.textContent = `✓ Deleted ${params.get('deleted')} deal(s).`;
  document.querySelector('h1')?.closest('div')?.parentNode?.prepend(n);
}
</script>

{% if request.query_params.get('embedded') == '1' %}
<script>try { window.parent.postMessage({ type: 'ct_deal_saved' }, '*'); } catch(e) {}</script>
{% endif %}
{% endblock %}
